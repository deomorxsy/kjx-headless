### kjx-headless
> Setting up a custom headless busybox/LFS distro



| **Category** | **CI** |
|:-------------|:-----------|
| **Tracers** | [![libbpf-core](https://github.com/deomorxsy/kjx-headless/actions/workflows/bee.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/bee.yml) [![libbpfgo](https://github.com/deomorxsy/kjx-headless/actions/workflows/libbpfgo.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/libbpfgo.yml) [![ayaya](https://github.com/deomorxsy/kjx-headless/actions/workflows/ayaya.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/ayaya.yml) [![ocaml-ci](https://github.com/deomorxsy/kjx-headless/actions/workflows/ocaml-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/ocaml-ci.yml) [![zig-wasm-ci](https://github.com/deomorxsy/kjx-headless/actions/workflows/zig-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/zig-ci.yml) [![bpftrace-ci](https://github.com/deomorxsy/kjx-headless/actions/workflows/bpftrace-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/bpftrace-ci.yml) [![ftrace-ci](https://github.com/deomorxsy/kjx-headless/actions/workflows/ftrace-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/ftrace-ci.yml) [![honeypotion](https://github.com/deomorxsy/kjx-headless/actions/workflows/hpota.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/hpota.yml) |
| **Core bootscripts** | [![initramfs](https://github.com/deomorxsy/kjx-headless/actions/workflows/initramfs.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/initramfs.yml) [![bzImage](https://github.com/deomorxsy/kjx-headless/actions/workflows/kernel.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/kernel.yml) [![dropbear](https://github.com/deomorxsy/kjx-headless/actions/workflows/dropbear.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/dropbear.yml) [![eltorito.img](https://github.com/deomorxsy/kjx-headless/actions/workflows/eltorito.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/eltorito.yml) [![runit-ci](https://github.com/deomorxsy/kjx-headless/actions/workflows/runit-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/runit-ci.yml) [![qonq-qdb](https://github.com/deomorxsy/kjx-headless/actions/workflows/qonq-qdb.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/qonq-qdb.yml) [![iso9660](https://github.com/deomorxsy/kjx-headless/actions/workflows/ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/ci.yml) [![vmdk](https://github.com/deomorxsy/kjx-headless/actions/workflows/cronaws.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/cronaws.yml) |
| **HLCR** | [![hlcr](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr.yml) [![podman](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr-podman.yml) [![docker](https://github.com/deomorxsy/kjx-headless/actions/workflows/docker.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr-docker.yml) [![crio](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr-crio.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/hlcr-crio.yml) |
| **LLCR** | [![llcr](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr.yml) [![runc](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-runc.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-runc.yml) [![crun](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-crun.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-crun.yml) [![containerd](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-containerd.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-containerd.yml) [![youki](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-youki.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/llcr-youki.yml)  |
| **MicroVMs** | [![microvms](https://github.com/deomorxsy/kjx-headless/actions/workflows/microvms.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/microvms.yml)  [![kjx-firecracker](https://github.com/deomorxsy/kjx-headless/actions/workflows/firecracker-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/firecracker-ci.yml) [![kjx-gvisor](https://github.com/deomorxsy/kjx-headless/actions/workflows/gvisor-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/gvisor-ci.yml) [![kjx-kata](https://github.com/deomorxsy/kjx-headless/actions/workflows/kata-ci.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/runit-ci.yml) |
| **Paravirt** | [![virtio](https://github.com/deomorxsy/kjx-headless/actions/workflows/virtio.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/virtio.yml) [![crosvm](https://github.com/deomorxsy/kjx-headless/actions/workflows/crosvm.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/crosvm.yml) [![rutabaga](https://github.com/deomorxsy/kjx-headless/actions/workflows/rutabaga.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/rutabaga.yml) |
| **Tests (stalled)** | [![coverage](https://github.com/deomorxsy/kjx-headless/actions/workflows/coverage.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/coverage.yml) [![unit-tests](https://github.com/deomorxsy/kjx-headless/actions/workflows/unit.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/unit.yml) |
| **Platforms** | [![libbpf-android](https://github.com/deomorxsy/kjx-headless/actions/workflows/build-android.yml/badge.svg)](https://github.com/deomorxsy/kjx-headless/actions/workflows/build-android.yml) |


---

Taking up from where [eulab-poc](https://github.com/deomorxsy/eulab-poc) left ;D

This proof-of-concept monorepo gathers concepts from several [1] constrained systems to create a *NIX Distro, Linux-based. The distribution is composed by Busybox/LFS. Continuous Integration is applied for infrastructure build automation much like AUFS. Aimed to explore performance and inner working of virtualized environments.

Check the [Gitlab mirror](https://gitlab.com/deomorxsy/kjx-headless) for an example with the platform's CI.


```sh
 .-"``"-.
/  _.-` (_) `-._
\   (_.----._)  /
 \     /    \  /
  `\  \____/  /`
    `-.____.-`      __     _
     /      \      / /__  (_)_ __
    /        \    /  '_/ / /\ \ /
   /_ |  | _\    /_/\_\_/ //_\_\
     |  | |          |___/         deomorxsy/kjx
     |__|__|  ----------------------------------------------
     /_ | _\   Reboot (01.00.0, ${GIT_CONTAINERFILE_HASH})
              ----------------------------------------------
```



The entire boot flowchart, from kernel init scripts to k3s initialization:
```
                                          kernel
                                            |
                                           1|
      .--- /etc/runit/reboot ---.                    14
  ,---|            2            |<--- (runit-init) <---- init 0|6
  |   '--- /etc/runit/stopit ---'          |
  |                                 13     |
  '------------------------------------>  3|
                                 .-----> runit
                                 |         |
                                 |         |
                        .---<---------<----+-------->---------.
                        |        |         |                  |
                       4|        |        6|                10|
                     runit/1     |      runit/2            runit/3
                        |        |         |                  |
                       5|        |        7|                11|
                   start things  |     runsvdir              sv
                        |        |         |                  |
                        |        |        8|                  |
   +---------------+    '--->---'|       runsv         /var/service/*
   | Parent Process|             |         |                  |
   +---------------+<------------'         |                  |
       |                                   |                12|
       |1. Fork libbpf                     |             stop things
       |2. Fork k3s process                |                  |
       |                                   |                  |
       |3. Send signal SIGUSR1 to libbpf   |            send SIGTERM
       v                                   v                   v
   +--------------------+             +--------------------+   |
   | Child: libbpf      |             | Child: k3s Process |---'
   | Program            |             | Wait for SIGUSR2   |
   +--------------------+             +--------------------+
            ^                                    ^
            | 4. Wait for SIGUSR1                | 6. Wait for SIGUSR2
            | (self-loop)                        | (self-loop)
            v                                    v
   +--------------------+             +--------------------+
   | Start Monitoring   |------------>| Signal: Monitoring |
   +--------------------+             | Started            |
            |                         +--------------------+
            |                                    |
            |                                    |
            | 5. Send SIGUSR2 to k3s Process     |
            v                                    v
    +--------------------+             +--------------------+
    | Monitoring Active  |             | Start k3s Process  |
    +--------------------+             +--------------------+
      |                    ┌──────────────────────┘
      |                    │
      |   ┌─────────────── ▼ ───────────────────┐
      v   │       ┌──────────────┐              │
 +--------│-------│server process│------------+ │
 |        ▼       └──────────────┘            | │
 |   +----------+                             | │
 |   |supervisor|──┐      +-------+ ◄───────┐ | │        ┌──────────────┐
 |   +----------+  │      |flannel|--------┐| | │ +------│client process│----+
 |                 ▼      +-------+        || | │ |      └──────────────┘    |
 | +----+    +----------+                  || | │ |    +-------+             |
 | |kine|◄───|API-server| ◄-┐ +----------+ || | │ |    |flannel|──────┐      |
 | +----+    +----------+   └-|kube-proxy|◄┘| | │ |    +-------+      ▼      |
 |               ▲  ▲  ▲      +----------+  | | │ |          ▲   +----------+|
 | +----------+  │  │  │                    | | │ | +------+ |   |kube-proxy||
 | |controller|  |  |  |      +-------+     | | │ | |tunnel| └─┐ +----------+|
 | |manager   |──┘  |  └──────|kubelet|─────┘ | └───|proxy |◄┐ |             |
 | +----------+  +---------+  +-------+       |   | +------+ | └─────┐       |
 +---------------|scheduler|-----│------------+   |      ▲   └────┐  |       |
                 +---------+     │                |      └───── +-------+    |
                                 │                +-------------|kubelet|----+
            +----------+         │                              +-------+
            |containerd| ◄───────┘               +----------+        │
            +----------+                         |containerd|◄───────┘
               │                                 +----------+
               │   +---+                            │
               └─► |Pod|                            │   +---+
                   +---+                            └─► |Pod|
                                                        +---+
```

Unit and Integration tests use the go testing package with code coverage. Currently exploring fuzz tests. There is also a chore using [bats-core](https://bats-core.readthedocs.io/). The adopted strategy is composed by spinning up a container, setting permissions with libcap and switching between test scopes for different containerized environments.


### References

[1] LFS, Sabotage, Alpine, Busybox OS, ALFS, PILFS, Cross Linux from Scratch, Embedded Linux from Scratch, Dragora Linux, Alpine Linux and Void Linux.

- [Alpine Wiki](https://wiki.alpinelinux.org/)
- [Sabotage](https://sabotage-linux.github.io/) && [devsonacid](https://sabotage-linux.neocities.org/blog/)
- [Buildroot manual](https://buildroot.org/downloads/manual/manual.pdf)
- [ALFS](https://www.linuxfromscratch.org/alfs/)
- [Cross Linux from Scratch](https://trac.clfs.org/)
- [Embedded Linux from Scratch](https://bootlin.com/doc/legacy/elfs/embedded_lfs.pdf)
- Dragora Linux [Handbook](http://www.dragora.org/download/web-handbook/) || [archive](https://archive.fo/FQekg)
- VoidLinux [docs](https://docs.voidlinux.org/)
- Alpine User [Handbook](https://docs.alpinelinux.org/user-handbook/0.1a/index.html)
- [TinyEmu](https://bellard.org/tinyemu/readme.txt)
- [Hardened Gentoo](https://wiki.gentoo.org/wiki/Project:Hardened)
- [Linux From Scratch on the Raspberry Pi](https://intestinate.com/pilfs/about.html)
- [runit-for-lfs](https://github.com/inthecloud247/runit-for-lfs)
- [containerd-rootless](https://github.com/containerd/nerdctl/blob/main/extras/rootless/containerd-rootless.sh)
- [rootless containers initiative](https://rootlesscontaine.rs/)
- [rhatdan's Podman in Action](https://www.manning.com/books/podman-in-action)
- [qemu-fuse-disk-export script](https://gitlab.com/hreitz/qemu-scripts/-/blob/main/qemu-fuse-disk-export.py)
- [youki tests!](https://github.com/containers/youki/blob/main/tests/k8s/Dockerfile)
- [the cromwell runntime](https://github.com/guni1192/cromwell)
- The firecracker scripts from [kubefire](https://github.com/innobead/kubefire)
